appId: com.splitex.app
name: Multi Currency Settlement with EOD FX (Mock)
---
- launchApp:
    clearState: true
- evalScript: ${output.runId = Date.now().toString()}

# Register user-1 (admin)
- tapOn:
    id: "login-go-register"
- tapOn:
    id: "register-display-name-input"
- inputText: "FX Admin ${output.runId}"
- tapOn:
    id: "register-email-input"
- inputText: "fxa${output.runId}@example.com"
- tapOn:
    id: "register-password-input"
- inputText: "Password123!"
- tapOn:
    id: "register-submit-button"
- assertVisible:
    id: "dashboard-create-event-button"

# Create event: USD expense currency, INR settlement currency, EOD FX
- tapOn:
    id: "dashboard-create-event-button"
- tapOn:
    id: "create-event-name-input"
- inputText: "Maestro FX ${output.runId}"
- tapOn:
    id: "create-event-currency-USD"
- tapOn:
    id: "create-event-settlement-INR"
- tapOn:
    id: "create-event-fx-mode-eod"
- tapOn:
    id: "create-event-submit-button"
- tapOn: "OK"

# Invite user-2
- tapOn:
    id: "event-detail-tab-participants"
- tapOn:
    id: "event-detail-open-invite-modal-participants"
- tapOn:
    id: "event-detail-invite-email-input"
- inputText: "fxm${output.runId}@example.com"
- tapOn:
    text: "Send"
- tapOn:
    text: "Send"
    optional: true
- extendedWaitUntil:
    notVisible: "Invite to Event"
    timeout: 10000
- tapOn:
    id: "event-detail-tab-invitations"
- extendedWaitUntil:
    visible: "fxm${output.runId}@example.com"
    timeout: 10000

# Switch to user-2
- launchApp:
    clearState: true

# Register user-2 and accept invite
- tapOn:
    id: "login-go-register"
- tapOn:
    id: "register-display-name-input"
- inputText: "FX Member ${output.runId}"
- tapOn:
    id: "register-email-input"
- inputText: "fxm${output.runId}@example.com"
- tapOn:
    id: "register-password-input"
- inputText: "Password123!"
- tapOn:
    id: "register-submit-button"
- tapOn:
    id: "dashboard-open-invitations"
- extendedWaitUntil:
    visible: "Accept"
    timeout: 10000
- tapOn: "Accept"
- assertVisible: "Accepted"
- tapOn: "OK"

# Switch back to user-1, add expense and settle
- launchApp:
    clearState: true
- tapOn:
    id: "login-email-input"
- inputText: "fxa${output.runId}@example.com"
- tapOn:
    id: "login-password-input"
- inputText: "Password123!"
- tapOn:
    id: "login-submit-button"
- extendedWaitUntil:
    visible: "Maestro FX ${output.runId}"
    timeout: 20000
- tapOn: "Maestro FX ${output.runId}"
- tapOn:
    id: "event-detail-add-expense-button"
- tapOn:
    id: "create-expense-title-input"
- inputText: "Hotel ${output.runId}"
- tapOn:
    id: "create-expense-amount-input"
- inputText: "300"
- hideKeyboard
- tapOn:
    id: "create-expense-submit-button"
- tapOn:
    id: "create-expense-submit-button"
    optional: true
- extendedWaitUntil:
    notVisible: "Add Expense"
    timeout: 30000
- tapOn:
    text: "OK"
    optional: true
- extendedWaitUntil:
    visible: "Maestro FX ${output.runId}"
    timeout: 10000
- assertVisible: "Hotel ${output.runId}"
- tapOn:
    id: "event-detail-settle-button"
- tapOn: "Generate"
- assertVisible: "Settlements"

# User-2 pays mock checkout
- launchApp:
    clearState: true
- tapOn:
    id: "login-email-input"
- inputText: "fxm${output.runId}@example.com"
- tapOn:
    id: "login-password-input"
- inputText: "Password123!"
- tapOn:
    id: "login-submit-button"
- extendedWaitUntil:
    visible: "Maestro FX ${output.runId}"
    timeout: 20000
- tapOn: "Maestro FX ${output.runId}"
- extendedWaitUntil:
    visible: "Settlements"
    timeout: 30000
- extendedWaitUntil:
    visible:
      id: "event-detail-settlement-pay-.*"
    timeout: 30000
- tapOn:
    id: "event-detail-settlement-pay-.*"
- assertVisible: "initiated"

# User-1 confirms settlement
- launchApp:
    clearState: true
- tapOn:
    id: "login-email-input"
- inputText: "fxa${output.runId}@example.com"
- tapOn:
    id: "login-password-input"
- inputText: "Password123!"
- tapOn:
    id: "login-submit-button"
- extendedWaitUntil:
    visible: "Maestro FX ${output.runId}"
    timeout: 20000
- tapOn: "Maestro FX ${output.runId}"
- extendedWaitUntil:
    visible:
      id: "event-detail-settlement-confirm-.*"
    timeout: 15000
- tapOn:
    id: "event-detail-settlement-confirm-.*"
- extendedWaitUntil:
    visible: "Settled"
    timeout: 15000
- assertVisible: "Close Event"
